<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vendor POS with Login + Sync</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
  <style>
    body { background:#f1f5f9; font-family:sans-serif; }
    .big-btn{padding:14px 20px;border-radius:12px;font-weight:600;}
  </style>
</head>
<body class="min-h-screen">

<div id="authSection" class="max-w-md mx-auto mt-16 bg-white p-6 rounded-xl shadow">
  <h2 class="text-2xl font-bold mb-4 text-center">Vendor Login</h2>
  <input id="email" type="email" placeholder="Email" class="w-full border rounded-lg p-3 mb-3"/>
  <input id="password" type="password" placeholder="Password" class="w-full border rounded-lg p-3 mb-4"/>
  <div class="flex gap-2">
    <button id="loginBtn" class="flex-1 big-btn bg-emerald-500 text-white">Login</button>
    <button id="registerBtn" class="flex-1 big-btn bg-sky-500 text-white">Register</button>
  </div>
</div>

<div id="appSection" class="hidden max-w-xl mx-auto p-4">
  <header class="flex justify-between items-center mb-4">
    <h1 class="text-xl font-bold">Vendor POS</h1>
    <div class="flex gap-2">
      <button id="syncBtn" class="big-btn bg-amber-400 text-white text-sm">Sync</button>
      <button id="logoutBtn" class="big-btn bg-red-500 text-white text-sm">Logout</button>
    </div>
  </header>

  <nav class="flex gap-2 mb-4">
    <button id="tabProducts" class="flex-1 big-btn bg-emerald-100">Products</button>
    <button id="tabSales" class="flex-1 big-btn bg-slate-100">Sales</button>
    <button id="tabHistory" class="flex-1 big-btn bg-slate-100">History</button>
  </nav>

  <!-- Products tab -->
  <section id="viewProducts">
    <h2 class="font-semibold mb-2 text-lg">Add / Edit Product</h2>
    <div class="space-y-3">
      <input id="p_name" placeholder="Product name" class="w-full border rounded p-3"/>
      <input id="p_price" type="number" placeholder="Price" class="w-full border rounded p-3"/>
      <div class="flex gap-2">
        <input id="p_qty" type="number" placeholder="Qty (optional)" class="flex-1 border rounded p-3"/>
        <select id="p_unit" class="border rounded p-3">
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="piece">piece</option>
          <option value="dozen">dozen</option>
        </select>
      </div>
      <div class="flex gap-2">
        <button id="saveProduct" class="flex-1 big-btn bg-emerald-500 text-white">Save</button>
        <button id="clearProduct" class="flex-1 big-btn bg-slate-200">Clear</button>
      </div>
    </div>
    <hr class="my-4"/>
    <h3 class="font-semibold text-lg mb-2">Products</h3>
    <div id="productList" class="space-y-2"></div>
  </section>

  <!-- Sales tab -->
  <section id="viewSales" class="hidden">
    <h2 class="font-semibold mb-3 text-lg">Record Sale</h2>
    <input id="saleSearch" placeholder="Search product" class="border rounded p-3 w-full mb-2"/>
    <select id="sale_product" class="border rounded p-3 w-full mb-2"></select>
    <input id="sale_qty" type="number" placeholder="Quantity" class="border rounded p-3 w-full mb-2"/>
    <div class="flex gap-2">
      <button id="addToCart" class="flex-1 big-btn bg-amber-400 text-white">Add to Cart</button>
      <button id="checkout" class="flex-1 big-btn bg-emerald-500 text-white">Checkout</button>
    </div>
    <div id="cartList" class="mt-4 space-y-2"></div>
  </section>

  <!-- History tab -->
  <section id="viewHistory" class="hidden">
    <h2 class="font-semibold mb-3 text-lg">Sales History</h2>
    <div id="historyList" class="space-y-2"></div>
  </section>
</div>

<script>
(async () => {
  // === Firebase Setup ===
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBcb4VreNGceQNxyCWh2tDl8ARGkCiptSQ",
  authDomain: "vendor-pos.firebaseapp.com",
  projectId: "vendor-pos",
  storageBucket: "vendor-pos.firebasestorage.app",
  messagingSenderId: "729715567147",
  appId: "1:729715567147:web:2b04c4ff14fd09daa7186e",
  measurementId: "G-CG95QJFKGW"
};
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // === DOM helpers ===
  const $ = id => document.getElementById(id);

  // Sections
  const authSection = $("authSection");
  const appSection = $("appSection");
  const tabProducts = $("tabProducts");
  const tabSales = $("tabSales");
  const tabHistory = $("tabHistory");
  const viewProducts = $("viewProducts");
  const viewSales = $("viewSales");
  const viewHistory = $("viewHistory");
  const syncBtn = $("syncBtn");
  const logoutBtn = $("logoutBtn");

  // === Local Storage Keys ===
  const LS_PRODUCTS = "vendor_products";
  const LS_SALES = "vendor_sales";

  function loadLS(key){ return JSON.parse(localStorage.getItem(key)||"[]"); }
  function saveLS(key,val){ localStorage.setItem(key,JSON.stringify(val)); }

  let products = loadLS(LS_PRODUCTS);
  let sales = loadLS(LS_SALES);
  let cart = [];
  let currentUser = null;

  // === Auth ===
  $("loginBtn").onclick = async()=>{
    const e=$("email").value, p=$("password").value;
    try{
      await auth.signInWithEmailAndPassword(e,p);
    }catch(err){ alert(err.message); }
  };
  $("registerBtn").onclick = async()=>{
    const e=$("email").value, p=$("password").value;
    try{
      await auth.createUserWithEmailAndPassword(e,p);
      alert("Registered! Now login.");
    }catch(err){ alert(err.message); }
  };

  logoutBtn.onclick = ()=> auth.signOut();

  auth.onAuthStateChanged(async user=>{
    if(user){
      currentUser = user;
      authSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      await loadFromCloud();
      refreshProducts();
      refreshSales();
      refreshHistory();
    } else {
      currentUser=null;
      appSection.classList.add("hidden");
      authSection.classList.remove("hidden");
    }
  });

  // === Tabs ===
  function showTab(tab){
    [viewProducts,viewSales,viewHistory].forEach(x=>x.classList.add("hidden"));
    [tabProducts,tabSales,tabHistory].forEach(x=>x.classList.remove("bg-emerald-200"));
    if(tab==="products"){viewProducts.classList.remove("hidden");tabProducts.classList.add("bg-emerald-200");}
    if(tab==="sales"){viewSales.classList.remove("hidden");tabSales.classList.add("bg-emerald-200");}
    if(tab==="history"){viewHistory.classList.remove("hidden");tabHistory.classList.add("bg-emerald-200");}
  }
  tabProducts.onclick=()=>showTab("products");
  tabSales.onclick=()=>showTab("sales");
  tabHistory.onclick=()=>showTab("history");
  showTab("products");

  // === Product CRUD ===
  const pName=$("p_name"),pPrice=$("p_price"),pQty=$("p_qty"),pUnit=$("p_unit");
  const productList=$("productList");
  let editId=null;

  $("saveProduct").onclick=()=>{
    const name=pName.value.trim(); if(!name)return alert("Enter name");
    const price=parseFloat(pPrice.value)||0;
    const qty=pQty.value?parseFloat(pQty.value):"";
    const unit=pUnit.value;
    if(editId){
      const i=products.findIndex(p=>p.id===editId);
      if(i>=0)products[i]={...products[i],name,price,qty,unit};
      editId=null;
    }else products.push({id:Date.now()+"",name,price,qty,unit});
    saveLS(LS_PRODUCTS,products);
    refreshProducts(); $("p_name").value=$("p_price").value=$("p_qty").value="";
  };
  $("clearProduct").onclick=()=>{editId=null;pName.value=pPrice.value=pQty.value="";};

  function refreshProducts(){
    productList.innerHTML="";
    if(!products.length)return productList.innerHTML="<div>No products</div>";
    products.forEach(p=>{
      const div=document.createElement("div");
      div.className="flex justify-between border rounded p-2";
      div.innerHTML=`<div><b>${p.name}</b> - ₹${p.price}/${p.unit} ${p.qty?`• ${p.qty}${p.unit}`:""}</div>
        <div class='flex gap-1'>
          <button class='bg-sky-500 text-white px-2 rounded editBtn'>Edit</button>
          <button class='bg-red-500 text-white px-2 rounded delBtn'>Del</button>
        </div>`;
      div.querySelector(".editBtn").onclick=()=>{editId=p.id;pName.value=p.name;pPrice.value=p.price;pQty.value=p.qty;pUnit.value=p.unit;};
      div.querySelector(".delBtn").onclick=()=>{if(confirm("Delete?")){products=products.filter(x=>x.id!==p.id);saveLS(LS_PRODUCTS,products);refreshProducts();}};
      productList.appendChild(div);
    });
    refreshSales();
  }

  // === Sales ===
  const saleProduct=$("sale_product"),saleQty=$("sale_qty"),cartList=$("cartList"),saleSearch=$("saleSearch");

  function refreshSales(){
    saleProduct.innerHTML=products.map(p=>`<option value='${p.id}'>${p.name} ₹${p.price}/${p.unit}</option>`).join("");
  }

  $("addToCart").onclick=()=>{
    const pid=saleProduct.value; const p=products.find(x=>x.id===pid);
    const q=parseFloat(saleQty.value); if(!q)return alert("Enter qty");
    cart.push({...p,qty:q}); saleQty.value=""; refreshCart();
  };

  function refreshCart(){
    cartList.innerHTML="";
    if(!cart.length)return cartList.innerHTML="<div>Cart empty</div>";
    let tot=0;
    cart.forEach((c,i)=>{
      tot+=c.qty*c.price;
      const row=document.createElement("div");
      row.className="flex justify-between border p-2 rounded";
      row.innerHTML=`<div>${c.name} • ${c.qty}${c.unit}</div><div>₹${(c.qty*c.price).toFixed(2)}</div>`;
      cartList.appendChild(row);
    });
    const t=document.createElement("div");
    t.className="text-right font-bold";t.textContent="Total ₹"+tot.toFixed(2);
    cartList.appendChild(t);
  }

  $("checkout").onclick=()=>{
    if(!cart.length)return alert("Cart empty");
    const s={id:Date.now()+"",time:new Date().toLocaleString(),items:cart.map(x=>({...x}))};
    sales.push(s); saveLS(LS_SALES,sales); cart=[]; refreshCart(); refreshHistory(); alert("Sale recorded");
  };

  function refreshHistory(){
    const list=$("historyList"); list.innerHTML="";
    if(!sales.length)return list.innerHTML="<div>No sales yet</div>";
    sales.slice().reverse().forEach(s=>{
      const div=document.createElement("div");
      div.className="border rounded p-2";
      div.innerHTML=`<div class='text-xs text-slate-500'>${s.time}</div>`+
        s.items.map(i=>`<div>${i.name} ${i.qty}${i.unit} ₹${(i.qty*i.price).toFixed(2)}</div>`).join("");
      list.appendChild(div);
    });
  }

  // === Sync ===
  syncBtn.onclick=async()=>{
    if(!navigator.onLine)return alert("No internet");
    if(!currentUser)return alert("Not logged in");
    const ref=db.collection("vendors").doc(currentUser.uid);
    await ref.set({updated:new Date()},{merge:true});
    await ref.collection("products").get().then(q=>q.forEach(d=>d.ref.delete()));
    for(const p of products){await ref.collection("products").doc(p.id).set(p);}
    await ref.collection("sales").get().then(q=>q.forEach(d=>d.ref.delete()));
    for(const s of sales){await ref.collection("sales").doc(s.id).set(s);}
    alert("Data synced!");
  };

  async function loadFromCloud(){
    if(!currentUser)return;
    const ref=db.collection("vendors").doc(currentUser.uid);
    const prodSnap=await ref.collection("products").get();
    const saleSnap=await ref.collection("sales").get();
    const pArr=prodSnap.docs.map(d=>d.data());
    const sArr=saleSnap.docs.map(d=>d.data());
    if(pArr.length){products=pArr;saveLS(LS_PRODUCTS,products);}
    if(sArr.length){sales=sArr;saveLS(LS_SALES,sales);}
  }

  saleSearch.oninput=()=> {
    const t=saleSearch.value.toLowerCase();
    const filtered=products.filter(p=>p.name.toLowerCase().startsWith(t));
    saleProduct.innerHTML=filtered.map(p=>`<option value='${p.id}'>${p.name} ₹${p.price}/${p.unit}</option>`).join("");
  };

})();
</script>
</body>
</html>
