<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vendor POS ‚Äî Bilingual + WhatsApp Billing</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

  <style>
    body { background:#f8fafc; font-family:Inter, system-ui, sans-serif; }
    .big-btn{ padding:10px 14px; border-radius:10px; font-weight:600; min-height:44px; }
    .muted { color:#6b7280; }
    .small { font-size:.85rem; }
    .lang-toggle { padding:8px 10px; border-radius:8px; background:#eef2ff; cursor:pointer; font-weight:600; }
    /* toast */
    #toast { position: fixed; left:50%; transform: translateX(-50%); bottom:24px; background:#111827; color:white; padding:10px 16px; border-radius:8px; display:none; z-index:2000; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
    /* modal */
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:2000; }
  </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4">

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- simple modal for bill preview -->
  <div id="billModal" style="display:none;" class="modal-backdrop">
    <div class="bg-white rounded-lg p-4 max-w-md w-full shadow">
      <h3 class="font-semibold mb-2">Bill / ‡§¨‡§ø‡§≤</h3>
      <pre id="billPreview" class="whitespace-pre-wrap text-sm bg-slate-50 p-2 rounded max-h-64 overflow-auto"></pre>
      <div class="flex gap-2 mt-3">
        <button id="copyBillBtn" class="flex-1 big-btn bg-emerald-500 text-white">üìã Copy</button>
        <button id="closeBillBtn" class="flex-1 big-btn bg-slate-200">Close</button>
      </div>
    </div>
  </div>

  <!-- AUTH -->
  <div id="authWrap" class="w-full max-w-md bg-white rounded-xl shadow p-6">
    <h2 data-i18n="title_auth" class="text-2xl font-bold mb-3 text-center">Vendor ‚Äî Register / Login</h2>
    <input id="regShop" placeholder="" data-i18n-placeholder="ph_shop" class="w-full border rounded p-3 mb-2" />
    <input id="email" type="email" placeholder="" data-i18n-placeholder="ph_email" class="w-full border rounded p-3 mb-2" />
    <input id="password" type="password" placeholder="" data-i18n-placeholder="ph_password" class="w-full border rounded p-3 mb-3" />
    <div class="flex gap-2">
      <button id="registerBtn" class="flex-1 big-btn bg-sky-500 text-white" data-i18n="btn_register">Register</button>
      <button id="loginBtn" class="flex-1 big-btn bg-emerald-500 text-white" data-i18n="btn_login">Login</button>
    </div>
    <p class="text-xs muted mt-3" data-i18n="auth_note">Register saves Shop name. Login downloads your vendor data (if present).</p>
  </div>

  <!-- APP -->
  <div id="appWrap" class="hidden w-full max-w-xl">
    <header class="flex items-center justify-between mb-4">
      <div>
        <div id="shopName" class="text-lg font-bold" data-i18n="app_title">Vendor POS</div>
        <div id="vendorInfo" class="small muted">email ‚Ä¢ uid</div>
      </div>
      <div class="flex items-center gap-2">
        <div id="syncStatus" class="px-3 py-1 rounded small muted" data-i18n="sync_manual">Manual sync</div>
        <button id="pushBtn" class="big-btn bg-amber-300 text-white small" data-i18n="btn_push">‚¨ÜÔ∏è Push</button>
        <button id="pullBtn" class="big-btn bg-sky-500 text-white small" data-i18n="btn_pull">‚¨áÔ∏è Pull</button>
        <button id="langToggle" class="lang-toggle" title="Toggle language">üåê ‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
        <button id="logoutBtn" class="big-btn bg-red-500 text-white small" data-i18n="btn_logout">Logout</button>
      </div>
    </header>

    <nav class="flex gap-2 mb-4">
      <button id="tabProducts" class="flex-1 big-btn bg-emerald-100" data-i18n="tab_products">Products</button>
      <button id="tabSales" class="flex-1 big-btn bg-slate-100" data-i18n="tab_sales">Sales</button>
      <button id="tabHistory" class="flex-1 big-btn bg-slate-100" data-i18n="tab_history">History</button>
    </nav>

    <main class="bg-white rounded-xl p-4 shadow">
      <!-- PRODUCTS -->
      <section id="view-products">
        <h3 class="font-semibold mb-2" data-i18n="heading_add_edit">Add / Edit Product</h3>
        <div class="space-y-2">
          <input id="p_name" data-i18n-placeholder="ph_product_name" placeholder="Name (e.g., Tomato)" class="w-full border rounded p-2" />
          <div class="flex gap-2">
            <input id="p_price" type="number" data-i18n-placeholder="ph_price" placeholder="Price (‚Çπ)" class="flex-1 border rounded p-2" />
            <select id="p_unit" class="border rounded p-2 w-36" aria-label="unit">
              <option value="kg" data-i18n="unit_kg">kg</option>
              <option value="g" data-i18n="unit_g">g</option>
              <option value="piece" data-i18n="unit_piece">piece</option>
              <option value="dozen" data-i18n="unit_dozen">dozen</option>
            </select>
            <input id="p_qty" type="number" data-i18n-placeholder="ph_qty" placeholder="Qty (opt)" class="w-28 border rounded p-2" />
          </div>
          <div class="flex gap-2 mt-2">
            <button id="saveProduct" class="flex-1 big-btn bg-emerald-500 text-white" data-i18n="btn_save">Save</button>
            <button id="clearProduct" class="flex-1 big-btn bg-slate-200" data-i18n="btn_clear">Clear</button>
          </div>
        </div>
        <hr class="my-3" />
        <h4 class="font-semibold mb-2" data-i18n="heading_products">Products</h4>
        <div id="productList" class="space-y-2 max-h-64 overflow-auto"></div>
      </section>

      <!-- SALES -->
      <section id="view-sales" class="hidden">
        <h3 class="font-semibold mb-2" data-i18n="heading_record_sale">Record Sale</h3>
        <input id="saleSearch" data-i18n-placeholder="ph_search" placeholder="Type first letters to search" class="w-full border rounded p-2 mb-2" />
        <select id="sale_product" class="w-full border rounded p-2 mb-2"></select>
        <div class="flex gap-2">
          <input id="sale_qty" type="number" data-i18n-placeholder="ph_qty" placeholder="Quantity" class="flex-1 border rounded p-2" />
          <div id="sale_unit_box" class="w-28 border rounded p-2 text-center muted">unit</div>
        </div>

        <!-- customer number input for WhatsApp -->
        <div class="mt-3 mb-2">
          <input id="custNumber" type="tel" placeholder="Customer WhatsApp number (optional) / ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§Ç‡§¨‡§∞ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)" class="w-full border rounded p-2" />
        </div>

        <div class="flex gap-2 mt-3">
          <button id="addToCart" class="flex-1 big-btn bg-amber-400 text-white" data-i18n="btn_add_cart">Add to Cart</button>
          <button id="openCart" class="flex-1 big-btn bg-slate-200" data-i18n="btn_open_cart">Open Cart</button>
        </div>
        <hr class="my-3" />
        <h4 class="font-semibold" data-i18n="heading_cart">Cart</h4>
        <div id="quickCart" class="space-y-2 max-h-56 overflow-auto"></div>
        <div class="mt-3">
          <button id="checkoutBtn" class="w-full big-btn bg-emerald-600 text-white" data-i18n="btn_checkout">Checkout</button>
        </div>

        <!-- Send Bill area appears after checkout -->
        <div id="sendBillArea" class="mt-3" style="display:none;">
          <button id="sendBillBtn" class="w-full big-btn bg-emerald-700 text-white">üì± Send Bill / ‡§¨‡§ø‡§≤ ‡§≠‡•á‡§ú‡•á‡§Ç</button>
        </div>
      </section>

      <!-- HISTORY -->
      <section id="view-history" class="hidden">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold mb-2" data-i18n="heading_history">Sales History</h3>
          <div class="flex gap-2 items-center">
            <div class="small muted mr-2" data-i18n="lbl_filter">Filter</div>
            <select id="historyFilter" class="border rounded p-2 small">
              <option value="all" data-i18n="filter_all">All</option>
              <option value="today" data-i18n="filter_today">Today</option>
              <option value="yesterday" data-i18n="filter_yesterday">Yesterday</option>
              <option value="week" data-i18n="filter_week">This Week</option>
              <option value="month" data-i18n="filter_month">This Month</option>
            </select>
          </div>
        </div>

        <div id="historyList" class="space-y-2 max-h-72 overflow-auto"></div>
      </section>

    </main>
  </div>

<script>
(async function(){

  // ---------- FIREBASE CONFIG ----------
  const firebaseConfig = {
  apiKey: "AIzaSyBcb4VreNGceQNxyCWh2tDl8ARGkCiptSQ",
  authDomain: "vendor-pos.firebaseapp.com",
  projectId: "vendor-pos",
  storageBucket: "vendor-pos.firebasestorage.app",
  messagingSenderId: "729715567147",
  appId: "1:729715567147:web:2b04c4ff14fd09daa7186e",
  measurementId: "G-CG95QJFKGW"
};

  // ---------- INIT ----------
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---------- I18N DICTIONARY (EN / HI) ----------
  const translations = {
    en: {
      title_auth: "Vendor ‚Äî Register / Login",
      ph_shop: "Shop name (for registration)",
      ph_email: "Email",
      ph_password: "Password",
      btn_register: "Register",
      btn_login: "Login",
      auth_note: "Register saves Shop name. Login downloads your vendor data (if present).",
      app_title: "Vendor POS",
      sync_manual: "Manual sync",
      btn_push: "‚¨ÜÔ∏è Push",
      btn_pull: "‚¨áÔ∏è Pull",
      btn_logout: "Logout",
      tab_products: "Products",
      tab_sales: "Sales",
      tab_history: "History",
      heading_add_edit: "Add / Edit Product",
      ph_product_name: "Name (e.g., Tomato)",
      ph_price: "Price (‚Çπ)",
      ph_qty: "Qty (opt)",
      unit_kg: "kg",
      unit_g: "g",
      unit_piece: "piece",
      unit_dozen: "dozen",
      btn_save: "Save",
      btn_clear: "Clear",
      heading_products: "Products",
      heading_record_sale: "Record Sale",
      ph_search: "Search product",
      btn_add_cart: "Add to Cart",
      btn_open_cart: "Open Cart",
      heading_cart: "Cart",
      btn_checkout: "Checkout",
      heading_history: "Sales History",
      lbl_filter: "Filter",
      filter_all: "All",
      filter_today: "Today",
      filter_yesterday: "Yesterday",
      filter_week: "This Week",
      filter_month: "This Month",
      // alerts/prompts
      registered: "Registered. Now login.",
      enter_shop_email_pass: "Enter shop, email & password to register.",
      enter_email_pass: "Enter email & password",
      not_signed_in: "Not signed in",
      no_internet: "No internet connection",
      product_required: "Name required",
      confirm_delete_product: "Delete this product?",
      product_deleted_local: "Product deleted locally",
      sale_recorded_local: "Sale recorded locally",
      push_confirm: "Push local data to cloud? This will upload new/updated products & sales and propagate deletions.",
      pull_confirm: "Pull from cloud? This will download new/updated products & sales from cloud and merge with local data.",
      push_complete: "Push complete.",
      pull_complete: "Pull complete.",
      sync_failed: "Sync failed",
      bill_ready: "Bill ready to send",
      bill_copied: "Bill copied to clipboard"
    },
    hi: {
      title_auth: "‡§µ‡§ø‡§ï‡•ç‡§∞‡•á‡§§‡§æ ‚Äî ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ / ‡§≤‡•â‡§ó‡§ø‡§®",
      ph_shop: "‡§¶‡•Å‡§ï‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è)",
      ph_email: "‡§à‡§Æ‡•á‡§≤",
      ph_password: "‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°",
      btn_register: "‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç",
      btn_login: "‡§≤‡•â‡§ó‡§ø‡§®",
      auth_note: "‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§¶‡•Å‡§ï‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§∏‡•á‡§µ ‡§π‡•ã‡§ó‡§æ‡•§ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§Ü‡§™‡§ï‡§æ ‡§°‡§æ‡§ü‡§æ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã‡§ó‡§æ (‡§Ø‡§¶‡§ø ‡§â‡§™‡§≤‡§¨‡•ç‡§ß)‡•§",
      app_title: "‡§µ‡§ø‡§ï‡•ç‡§∞‡•á‡§§‡§æ POS",
      sync_manual: "‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§∏‡§ø‡§Ç‡§ï",
      btn_push: "‚¨ÜÔ∏è ‡§≠‡•á‡§ú‡•á‡§Ç",
      btn_pull: "‚¨áÔ∏è ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç",
      btn_logout: "‡§≤‡•â‡§ó‡§Ü‡§â‡§ü",
      tab_products: "‡§â‡§§‡•ç‡§™‡§æ‡§¶",
      tab_sales: "‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä",
      tab_history: "‡§á‡§§‡§ø‡§π‡§æ‡§∏",
      heading_add_edit: "‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç / ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç",
      ph_product_name: "‡§®‡§æ‡§Æ (‡§â‡§¶‡§æ., ‡§ü‡§Æ‡§æ‡§ü‡§∞)",
      ph_price: "‡§ï‡•Ä‡§Æ‡§§ (‚Çπ)",
      ph_qty: "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)",
      unit_kg: "‡§ï‡§ø‡§≤‡•ã",
      unit_g: "‡§ó‡•ç‡§∞‡§æ‡§Æ",
      unit_piece: "‡§™‡•Ä‡§∏",
      unit_dozen: "‡§°‡§ú‡§º‡§®",
      btn_save: "‡§∏‡§π‡•á‡§ú‡•á‡§Ç",
      btn_clear: "‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç",
      heading_products: "‡§â‡§§‡•ç‡§™‡§æ‡§¶",
      heading_record_sale: "‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
      ph_search: "‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ñ‡•ã‡§ú‡•á‡§Ç",
      btn_add_cart: "‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
      btn_open_cart: "‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ñ‡•ã‡§≤‡•á‡§Ç",
      heading_cart: "‡§ï‡§æ‡§∞‡•ç‡§ü",
      btn_checkout: "‡§ö‡•á‡§ï‡§Ü‡§â‡§ü",
      heading_history: "‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§á‡§§‡§ø‡§π‡§æ‡§∏",
      lbl_filter: "‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞",
      filter_all: "‡§∏‡§¨",
      filter_today: "‡§Ü‡§ú",
      filter_yesterday: "‡§ï‡§≤",
      filter_week: "‡§Ø‡§π ‡§∏‡§™‡•ç‡§§‡§æ‡§π",
      filter_month: "‡§Ø‡§π ‡§Æ‡§π‡•Ä‡§®‡§æ",
      // alerts/prompts
      registered: "‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§ ‡§Ö‡§¨ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç‡•§",
      enter_shop_email_pass: "‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¶‡•Å‡§ï‡§æ‡§®, ‡§à‡§Æ‡•á‡§≤ ‡§î‡§∞ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§",
      enter_email_pass: "‡§à‡§Æ‡•á‡§≤ ‡§î‡§∞ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
      not_signed_in: "‡§≤‡•â‡§ó‡§ø‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à",
      no_internet: "‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à",
      product_required: "‡§®‡§æ‡§Æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à",
      confirm_delete_product: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?",
      product_deleted_local: "‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ",
      sale_recorded_local: "‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¶‡§∞‡•ç‡§ú ‡§ï‡•Ä ‡§ó‡§à",
      push_confirm: "‡§≤‡•ã‡§ï‡§≤ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç? ‡§á‡§∏‡§∏‡•á ‡§®‡§è/‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§è ‡§ó‡§è ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§î‡§∞ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§≠‡•á‡§ú‡•á ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á ‡§î‡§∞ ‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ ‡§≠‡•Ä ‡§π‡•ã‡§ó‡§æ‡•§",
      pull_confirm: "‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç? ‡§á‡§∏‡§∏‡•á ‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§∏‡•á ‡§®‡§è/‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§è ‡§ó‡§è ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§î‡§∞ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã‡§Ç‡§ó‡•á ‡§î‡§∞ ‡§≤‡•ã‡§ï‡§≤ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Æ‡§∞‡•ç‡§ú ‡§π‡•ã‡§Ç‡§ó‡•á‡•§",
      push_complete: "‡§™‡•Å‡§∂ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü‡•§",
      pull_complete: "‡§™‡•Å‡§≤ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü‡•§",
      sync_failed: "‡§∏‡§ø‡§Ç‡§ï ‡§µ‡§ø‡§´‡§≤",
      bill_ready: "‡§¨‡§ø‡§≤ ‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à",
      bill_copied: "‡§¨‡§ø‡§≤ ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ"
    }
  };

  // ---------- I18N HELPERS ----------
  function getSavedLang(){
    const s = localStorage.getItem('language');
    if(s) return s;
    const nav = (navigator.language || navigator.userLanguage || 'en').toLowerCase();
    return nav.startsWith('hi') ? 'hi' : 'en';
  }
  let currentLang = getSavedLang();

  function applyTranslations(lang){
    currentLang = lang;
    // apply text nodes with data-i18n
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      if(translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
    });
    // apply placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
      const key = el.getAttribute('data-i18n-placeholder');
      if(translations[lang] && translations[lang][key]) el.placeholder = translations[lang][key];
    });
    // apply select option texts (some are marked with data-i18n)
    document.querySelectorAll('option[data-i18n]').forEach(opt=>{
      const key = opt.getAttribute('data-i18n');
      if(translations[lang] && translations[lang][key]) opt.textContent = translations[lang][key];
    });

    // update toggle button text: show the other language label
    const toggle = document.getElementById('langToggle');
    if(toggle){
      toggle.textContent = (lang === 'en') ? 'üåê ‡§π‡§ø‡§Ç‡§¶‡•Ä' : 'üåê English';
    }

    localStorage.setItem('language', lang);
  }

  function showBilingualAlert(keyOrText){
    let enText = '', hiText = '';
    if(typeof keyOrText === 'string' && translations.en[keyOrText] && translations.hi[keyOrText]){
      enText = translations.en[keyOrText];
      hiText = translations.hi[keyOrText];
    } else if (typeof keyOrText === 'string'){
      enText = keyOrText;
      hiText = translations.hi['sync_failed'] || '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø';
    } else {
      enText = String(keyOrText);
      hiText = translations.hi['sync_failed'] || '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø';
    }
    alert(enText + " / " + hiText);
  }
  function showBilingualConfirm(key){
    let enText = translations.en[key] || key;
    let hiText = translations.hi[key] || key;
    return confirm(enText + " / " + hiText);
  }

  // toast helper
  function showToast(textKeyOrText){
    let text = '';
    if(typeof textKeyOrText === 'string' && translations[currentLang] && translations[currentLang][textKeyOrText]){
      // show in current language only for toast (short)
      text = translations[currentLang][textKeyOrText];
    } else {
      text = textKeyOrText;
    }
    const t = document.getElementById('toast');
    t.textContent = text;
    t.style.display = 'block';
    setTimeout(()=>{ t.style.opacity = '1'; }, 10);
    setTimeout(()=>{ t.style.display = 'none'; t.style.opacity = '0'; }, 3000);
  }

  // ---------- HELPERS & LS ----------
  const $ = id => document.getElementById(id);
  const LS_PRODUCTS = (uid) => `vendor_products_${uid}`;
  const LS_SALES = (uid) => `vendor_sales_${uid}`;
  function loadLS(key){ try{ return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ return []; } }
  function saveLS(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

  // App state
  let currentUser = null;
  let currentUID = null;
  let currentShop = null;
  let products = []; // array of {id,name,price,qty,unit,lastUpdated,deleted?}
  let sales = [];    // array of {id,time,timeStr,items:[{id,name,price,qty,unit}], lastUpdated}
  let cart = [];
  let dirty = false;

  // DOM refs
  const authWrap = $('authWrap'), appWrap = $('appWrap');
  const shopNameEl = $('shopName'), vendorInfoEl = $('vendorInfo'), syncStatusEl = $('syncStatus');
  const pushBtn = $('pushBtn'), pullBtn = $('pullBtn'), logoutBtn = $('logoutBtn');
  const tabProducts = $('tabProducts'), tabSales = $('tabSales'), tabHistory = $('tabHistory');
  const viewProducts = $('view-products'), viewSales = $('view-sales'), viewHistory = $('view-history');

  const p_name = $('p_name'), p_price = $('p_price'), p_qty = $('p_qty'), p_unit = $('p_unit');
  const saveProductBtn = $('saveProduct'), clearProductBtn = $('clearProduct'), productList = $('productList');

  const saleSearch = $('saleSearch'), sale_product = $('sale_product'), sale_qty = $('sale_qty'), sale_unit_box = $('sale_unit_box');
  const addToCartBtn = $('addToCart'), openCartBtn = $('openCart'), quickCart = $('quickCart'), checkoutBtn = $('checkoutBtn');

  const historyList = $('historyList'), historyFilter = $('historyFilter');

  const registerBtn = $('registerBtn'), loginBtn = $('loginBtn'), regShop = $('regShop'), emailInp = $('email'), passInp = $('password');

  const sendBillArea = $('sendBillArea'), sendBillBtn = $('sendBillBtn'), custNumberEl = $('custNumber');
  const billModal = $('billModal'), billPreview = $('billPreview'), copyBillBtn = $('copyBillBtn'), closeBillBtn = $('closeBillBtn');

  // UTIL
  const now = () => Date.now();
  const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,8);
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function markDirty(v=true){ dirty = v; syncStatusEl.textContent = (!navigator.onLine) ? translations.en['no_internet'] + ' / ' + translations.hi['no_internet'] : (dirty ? translations.en['sync_manual'] + ' / ' + translations.hi['sync_manual'] : translations.en['sync_manual'] + ' / ' + translations.hi['sync_manual']); }

  // ---------- AUTH ----------
  registerBtn.onclick = async () => {
    const shop = regShop.value.trim(); const email = emailInp.value.trim(); const pass = passInp.value;
    if(!shop || !email || !pass) return showBilingualAlert('enter_shop_email_pass');
    try{
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      const user = cred.user;
      await db.collection('vendors').doc(user.uid).set({
        shopName: shop,
        email: email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
      showBilingualAlert('registered');
    } catch(e){ showBilingualAlert(e.message || 'Error'); }
  };

  loginBtn.onclick = async () => {
    const email = emailInp.value.trim(); const pass = passInp.value;
    if(!email || !pass) return showBilingualAlert('enter_email_pass');
    try{ await auth.signInWithEmailAndPassword(email, pass); } catch(e){ showBilingualAlert(e.message || 'Error'); }
  };

  logoutBtn.onclick = async () => { await auth.signOut(); };

  auth.onAuthStateChanged(async user => {
    if(user){
      currentUser = user; currentUID = user.uid;
      // fetch profile
      try{
        const prof = await db.collection('vendors').doc(currentUID).get();
        currentShop = (prof.exists && prof.data().shopName) ? prof.data().shopName : 'Shop';
      }catch(e){ currentShop = 'Shop'; }
      // load namespaced local data
      products = loadLS(LS_PRODUCTS(currentUID)); sales = loadLS(LS_SALES(currentUID));
      appWrap.classList.remove('hidden'); authWrap.classList.add('hidden');
      shopNameEl.textContent = currentShop;
      vendorInfoEl.textContent = `${currentUser.email} ‚Ä¢ UID: ${currentUID}`;
      markDirty(true); // assume local changes until user Push/Pull
      refreshProductsUI(); refreshCartUI(); refreshHistoryUI();
    } else {
      currentUser = null; currentUID = null; currentShop = null;
      authWrap.classList.remove('hidden'); appWrap.classList.add('hidden');
    }
  });

  // ---------- TABS ----------
  function show(tab){
    viewProducts.classList.add('hidden'); viewSales.classList.add('hidden'); viewHistory.classList.add('hidden');
    tabProducts.classList.remove('bg-emerald-200'); tabSales.classList.remove('bg-emerald-200'); tabHistory.classList.remove('bg-emerald-200');
    if(tab==='products'){ viewProducts.classList.remove('hidden'); tabProducts.classList.add('bg-emerald-200'); }
    if(tab==='sales'){ viewSales.classList.remove('hidden'); tabSales.classList.add('bg-emerald-200'); }
    if(tab==='history'){ viewHistory.classList.remove('hidden'); tabHistory.classList.add('bg-emerald-200'); }
  }
  tabProducts.onclick=()=>show('products'); tabSales.onclick=()=>show('sales'); tabHistory.onclick=()=>show('history');
  show('products');

  // ---------- PRODUCTS CRUD (local) ----------
  let editProductId = null;
  saveProductBtn.onclick = () => {
    const name = p_name.value.trim(); if(!name) return showBilingualAlert('product_required');
    const price = Number(p_price.value) || 0; const qty = p_qty.value === '' ? '' : Number(p_qty.value); const unit = p_unit.value;
    if(editProductId){
      const i = products.findIndex(x => x.id === editProductId);
      if(i>=0) products[i] = { ...products[i], name, price, qty, unit, lastUpdated: now(), deleted: false };
      editProductId = null;
    } else {
      products.push({ id: uid(), name, price, qty, unit, lastUpdated: now() });
    }
    saveLS(LS_PRODUCTS(currentUID), products);
    markDirty(true);
    refreshProductsUI();
    p_name.value=''; p_price.value=''; p_qty.value='';
  };

  clearProductBtn.onclick = ()=>{ editProductId=null; p_name.value=''; p_price.value=''; p_qty.value=''; };

  function refreshProductsUI(){
    productList.innerHTML = '';
    const active = products.filter(p => !p.deleted).sort((a,b) => (a.name||'').localeCompare(b.name||''));
    if(!active.length){ productList.innerHTML = '<div class="muted">No products</div>'; refreshSaleProducts(); return; }
    active.forEach(p=>{
      const row = document.createElement('div');
      row.className = 'flex justify-between items-center border rounded p-2';
      // show translated labels for edit/delete buttons
      const editLabel = translations[currentLang]['btn_save'] || 'Edit';
      const delLabel = translations[currentLang]['btn_clear'] || 'Del';
      row.innerHTML = `<div><div class="font-semibold">${escapeHtml(p.name)}</div><div class="small muted">‚Çπ ${Number(p.price).toFixed(2)} / ${p.unit} ${p.qty!=='' ? ' ‚Ä¢ ' + p.qty + ' ' + p.unit : ''}</div></div>
        <div class="flex gap-2">
          <button class="bg-sky-500 text-white px-2 rounded edit">${escapeHtml(editLabel)}</button>
          <button class="bg-red-500 text-white px-2 rounded del">${escapeHtml(delLabel)}</button>
        </div>`;
      row.querySelector('.edit').onclick = ()=>{ editProductId = p.id; p_name.value = p.name; p_price.value = p.price; p_qty.value = p.qty; p_unit.value = p.unit; window.scrollTo({top:0,behavior:'smooth'}); };
      row.querySelector('.del').onclick = ()=>{ 
        if(!showBilingualConfirm('confirm_delete_product')) return;
        const idx = products.findIndex(x=>x.id===p.id);
        if(idx>=0){ products[idx].deleted = true; products[idx].lastUpdated = now(); saveLS(LS_PRODUCTS(currentUID), products); markDirty(true); refreshProductsUI(); showBilingualAlert('product_deleted_local'); }
      };
      productList.appendChild(row);
    });
    refreshSaleProducts();
  }

  // ---------- SALES (local) ----------
  saleSearch.oninput = ()=> refreshSaleProducts(saleSearch.value);
  function refreshSaleProducts(filterTerm=''){
    const term = (filterTerm||'').trim().toLowerCase();
    let list = products.filter(p => !p.deleted).slice();
    if(term){
      const starts = list.filter(p => p.name.toLowerCase().startsWith(term));
      const includes = list.filter(p => !p.name.toLowerCase().startsWith(term) && p.name.toLowerCase().includes(term));
      list = starts.concat(includes);
    }
    sale_product.innerHTML = list.map(p => `<option value="${p.id}">${escapeHtml(p.name)} ‚Äî ‚Çπ${Number(p.price).toFixed(2)}/${p.unit}</option>`).join('') || '<option value="">No match</option>';
    const sel = products.find(x => x.id === sale_product.value) || list[0];
    sale_unit_box.textContent = sel ? sel.unit : '‚Äî';
  }

  addToCartBtn.onclick = ()=>{
    const pid = sale_product.value; const p = products.find(x=>x.id===pid); if(!p) return showBilingualAlert('product_required');
    const q = Number(sale_qty.value); if(!q || q<=0) return showBilingualAlert('product_required');
    const existing = cart.find(x=>x.id===p.id && x.unit===p.unit);
    if(existing) existing.qty = Number(existing.qty) + q; else cart.push({ id: p.id, name: p.name, price: p.price, qty: q, unit: p.unit });
    sale_qty.value=''; refreshCartUI();
  };

  function refreshCartUI(){
    quickCart.innerHTML = '';
    if(!cart.length) return quickCart.innerHTML = '<div class="muted">Cart empty</div>';
    cart.forEach((it, idx) => {
      const div = document.createElement('div');
      div.className = 'flex justify-between items-center border rounded p-2';
      div.innerHTML = `<div><b>${escapeHtml(it.name)}</b><div class="muted small">${it.qty} ${it.unit} ‚Ä¢ ‚Çπ ${Number(it.price).toFixed(2)}</div></div>
        <div class="flex gap-1">
          <button class="px-2 bg-slate-200 rounded dec">-</button>
          <button class="px-2 bg-slate-200 rounded inc">+</button>
          <button class="px-2 bg-red-500 text-white rounded rm">X</button>
        </div>`;
      div.querySelector('.inc').onclick = ()=>{ cart[idx].qty = Number(cart[idx].qty) + 1; refreshCartUI(); };
      div.querySelector('.dec').onclick = ()=>{ cart[idx].qty = Math.max(0.01, Number(cart[idx].qty) - 1); refreshCartUI(); };
      div.querySelector('.rm').onclick = ()=>{ cart.splice(idx,1); refreshCartUI(); };
      quickCart.appendChild(div);
    });
    const total = cart.reduce((s,it)=> s + (it.qty * it.price), 0);
    const foot = document.createElement('div'); foot.className='text-right font-semibold mt-2'; foot.textContent = 'Total ‚Çπ ' + total.toFixed(2);
    quickCart.appendChild(foot);
  }

  checkoutBtn.onclick = ()=>{
    if(!cart.length) return showBilingualAlert('product_required');
    const sale = { id: uid(), time: now(), timeStr: new Date().toLocaleString(), items: cart.map(x=>({...x})), lastUpdated: now() };
    sales.push(sale);
    saveLS(LS_SALES(currentUID), sales);
    // deduct stock if provided
    cart.forEach(it=>{
      const prod = products.find(p=>p.id===it.id);
      if(prod && prod.qty !== '' && !isNaN(prod.qty)){ prod.qty = Number(prod.qty) - Number(it.qty); if(prod.qty < 0) prod.qty = 0; prod.lastUpdated = now(); }
    });
    saveLS(LS_PRODUCTS(currentUID), products);
    cart = []; refreshCartUI(); refreshProductsUI(); refreshHistoryUI(); markDirty(true);
    showBilingualAlert('sale_recorded_local');

    // show send bill area
    sendBillArea.style.display = 'block';
    showToast('bill_ready');
  };

  // ---------- prepare bilingual bill text ----------
  function buildBilingualBill(sale){
    // sale: a sale object as saved; include shop name and footer
    const shop = currentShop || 'Shop';
    const dt = new Date(sale.time);
    const dtStr = dt.toLocaleString();
    const lines = [];
    lines.push(`üßæ ${shop} / ‡§¶‡•Å‡§ï‡§æ‡§®: ${shop}`);
    lines.push(`Date / ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${dtStr}`);
    lines.push(`-----------------------------`);
    sale.items.forEach(it=>{
      const enLine = `${it.name} ‚Äî ${it.qty} ${it.unit} √ó ‚Çπ${Number(it.price)} = ‚Çπ${(it.qty * it.price).toFixed(2)}`;
      // try to find Hindi name fallback same as en (we don't have translations for product names)
      const hiLine = `${it.name} ‚Äî ${it.qty} ${it.unit} √ó ‚Çπ${Number(it.price)} = ‚Çπ${(it.qty * it.price).toFixed(2)}`;
      lines.push(`${enLine} / ${hiLine}`);
    });
    lines.push(`-----------------------------`);
    const total = sale.items.reduce((s,it)=> s + (it.qty * it.price), 0);
    lines.push(`Total / ‡§ï‡•Å‡§≤: ‚Çπ${total.toFixed(2)}`);
    lines.push(``);
    lines.push(`Thank you! / ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶ üôè`);
    lines.push(`Bill generated using Vendor POS App / ‡§¨‡§ø‡§≤ Vendor POS App ‡§∏‡•á ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ üì±`);
    return lines.join('\n');
  }

  // ---------- Send Bill logic ----------
  sendBillBtn.onclick = () => {
    // use the most recent sale
    if(!sales.length) return showBilingualAlert('product_required');
    const sale = sales[sales.length - 1];
    const text = buildBilingualBill(sale);
    const rawNumber = (custNumberEl.value || '').trim();
    if(rawNumber){
      // normalize number: remove non-digits
      let digits = rawNumber.replace(/\D/g,'');
      // if 10-digit assume India -> prefix 91
      if(digits.length === 10) digits = '91' + digits;
      // if starts with 0, remove leading zeros then handle
      if(digits.startsWith('0')) digits = digits.replace(/^0+/, '');
      const encoded = encodeURIComponent(text);
      const waUrl = `https://wa.me/${digits}?text=${encoded}`;
      // open in new tab/window - mobile will open app
      window.open(waUrl, '_blank');
      showToast('bill_ready');
    } else {
      // show modal with bill & copy option
      billPreview.textContent = text;
      billModal.style.display = 'flex';
    }
  };

  copyBillBtn.onclick = async () => {
    try{
      await navigator.clipboard.writeText(billPreview.textContent);
      showToast('bill_copied');
    }catch(e){
      // fallback select & execCommand
      const ta = document.createElement('textarea'); ta.value = billPreview.textContent; document.body.appendChild(ta); ta.select();
      try { document.execCommand('copy'); showToast('bill_copied'); } catch(e2){ alert('Copy failed'); }
      ta.remove();
    }
  };
  closeBillBtn.onclick = () => { billModal.style.display = 'none'; };

  // ---------- HISTORY ----------
  function refreshHistoryUI(){
    historyList.innerHTML = '';

    // filter by date
    const filter = historyFilter.value || 'all';
    const isSameDay = (d1, d2) => new Date(d1).toDateString() === new Date(d2).toDateString();
    const startOfWeek = (d) => { const dt = new Date(d); const day = dt.getDay(); dt.setDate(dt.getDate() - day); dt.setHours(0,0,0,0); return dt; };
    const startOfMonth = (d) => { const dt = new Date(d); dt.setDate(1); dt.setHours(0,0,0,0); return dt; };

    const filteredSales = sales.filter(s => {
      if(!s.time) return false;
      const t = new Date(s.time);
      const today = new Date();
      if(filter === 'today') return isSameDay(t, today);
      if(filter === 'yesterday'){ const y = new Date(); y.setDate(y.getDate() -1); return isSameDay(t, y); }
      if(filter === 'week'){ return t >= startOfWeek(today); }
      if(filter === 'month'){ return t >= startOfMonth(today); }
      return true; // all
    });

    if(!filteredSales.length) { historyList.innerHTML = '<div class="muted">No sales for selected period</div>'; return; }

    // Grand total for filtered sales
    const grandTotal = filteredSales.reduce((sum, s) => sum + s.items.reduce((st, it) => st + it.qty * it.price, 0), 0);
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'p-2 mb-2 rounded bg-emerald-100 text-emerald-800 font-semibold flex justify-between';
    summaryDiv.innerHTML = `<span>${translations[currentLang]['heading_history'] || 'Grand Total (filtered)'}</span><span>‚Çπ ${grandTotal.toFixed(2)}</span>`;
    historyList.appendChild(summaryDiv);

    filteredSales.slice().reverse().forEach(s=>{
      const d = document.createElement('div'); d.className='border rounded p-2 bg-white mb-2';
      const itemsHtml = s.items.map(it => `<div>${escapeHtml(it.name)} ‚Ä¢ ${it.qty}${it.unit} ‚Äî ‚Çπ ${(it.qty*it.price).toFixed(2)}</div>`).join('');
      const total = s.items.reduce((sum,it)=> sum + it.qty * it.price, 0);
      d.innerHTML = `<div class="small muted">${new Date(s.time).toLocaleString()}</div>${itemsHtml}<div class="mt-2 text-right font-semibold border-t pt-1">Total: ‚Çπ ${total.toFixed(2)}</div>`;
      historyList.appendChild(d);
    });
  }
  historyFilter.onchange = () => refreshHistoryUI();

  // ---------- PUSH / PULL (merge) ----------
  pushBtn.onclick = async () => {
    if(!navigator.onLine) return showBilingualAlert('no_internet');
    if(!currentUID) return showBilingualAlert('not_signed_in');
    if(!showBilingualConfirm('push_confirm')) return;

    const vendorRef = db.collection('vendors').doc(currentUID);
    const prodCol = vendorRef.collection('products');
    const salesCol = vendorRef.collection('sales');

    try{
      await vendorRef.set({ shopName: currentShop || '', email: currentUser.email }, { merge: true });

      for(const p of products){
        if(p.deleted){
          await prodCol.doc(p.id).set({ deleted: true, lastUpdated: p.lastUpdated }, { merge:true });
        } else {
          await prodCol.doc(p.id).set(p, { merge:true });
        }
      }
      for(const s of sales){
        await salesCol.doc(s.id).set(s, { merge:true });
      }

      // remove local deleted items
      products = products.filter(p => !p.deleted);
      saveLS(LS_PRODUCTS(currentUID), products);
      markDirty(false);
      showBilingualAlert('push_complete');
    } catch(err){
      console.error(err);
      showBilingualAlert(err.message || translations.en['sync_failed']);
      markDirty(true);
    }
    refreshProductsUI(); refreshCartUI(); refreshHistoryUI();
  };

  pullBtn.onclick = async () => {
    if(!navigator.onLine) return showBilingualAlert('no_internet');
    if(!currentUID) return showBilingualAlert('not_signed_in');
    if(!showBilingualConfirm('pull_confirm')) return;

    const vendorRef = db.collection('vendors').doc(currentUID);
    const prodCol = vendorRef.collection('products');
    const salesCol = vendorRef.collection('sales');

    try{
      const cloudProdsSnap = await prodCol.get();
      const cloudSalesSnap = await salesCol.get();
      const cloudProds = cloudProdsSnap.docs.map(d => d.data());
      const cloudSales = cloudSalesSnap.docs.map(d => d.data());

      // MERGE PRODUCTS
      const map = {};
      for(const cp of cloudProds){
        map[cp.id] = { ...cp };
      }
      for(const lp of products){
        if(!lp.id){ lp.id = uid(); lp.lastUpdated = lp.lastUpdated || now(); }
        const existing = map[lp.id];
        if(!existing) {
          map[lp.id] = { ...lp };
        } else {
          const cloudLU = existing.lastUpdated || 0;
          const localLU = lp.lastUpdated || 0;
          if(localLU > cloudLU) map[lp.id] = { ...lp };
        }
      }

      // Remove cloud-deleted items from merged map and also schedule cloud cleanup
      const finalProducts = [];
      const toDeleteCloudIds = [];
      for(const id in map){
        const item = map[id];
        if(item.deleted){
          toDeleteCloudIds.push(id);
        } else {
          finalProducts.push(item);
        }
      }

      // MERGE SALES
      const salesMap = {};
      for(const cs of cloudSales) salesMap[cs.id] = { ...cs };
      for(const ls of sales){
        if(!ls.id){ ls.id = uid(); ls.lastUpdated = ls.lastUpdated || now(); }
        const existing = salesMap[ls.id];
        if(!existing) salesMap[ls.id] = { ...ls };
        else {
          const cloudLU = existing.lastUpdated || 0;
          const localLU = ls.lastUpdated || 0;
          if(localLU > cloudLU) salesMap[ls.id] = { ...ls };
        }
      }
      const finalSales = Object.values(salesMap);

      // Normalize & save merged locally
      for (const p of finalProducts) { if (p.deleted === undefined) p.deleted = false; }
      products = finalProducts.sort((a,b) => (a.name||'').localeCompare(b.name||''));
      sales = finalSales.sort((a,b)=> b.time - a.time);
      saveLS(LS_PRODUCTS(currentUID), products);
      saveLS(LS_SALES(currentUID), sales);

      // Cleanup cloud docs that were marked deleted
      for(const did of toDeleteCloudIds){
        await prodCol.doc(did).delete().catch(()=>{ /* ignore */ });
      }

      markDirty(false);
      showBilingualAlert('pull_complete');
    } catch(err){
      console.error(err);
      showBilingualAlert(err.message || translations.en['sync_failed']);
      markDirty(true);
    }
    refreshProductsUI(); refreshCartUI(); refreshHistoryUI();
  };

  // ---------- connectivity UI ----------
  window.addEventListener('online', ()=> { syncStatusEl.textContent = dirty ? 'Pending üü°' : 'Synced ‚úÖ'; });
  window.addEventListener('offline', ()=> { syncStatusEl.textContent = 'Offline üî¥'; });

  syncStatusEl.textContent = navigator.onLine ? translations[currentLang]['sync_manual'] + ' / ' + translations.hi['sync_manual'] : 'Offline üî¥';

  // ---------- initial UI refresh & i18n ----------
  applyTranslations(currentLang);
  refreshProductsUI();
  refreshCartUI();
  refreshHistoryUI();

  // language toggle
  document.getElementById('langToggle').addEventListener('click', ()=>{
    const newLang = (currentLang === 'en') ? 'hi' : 'en';
    applyTranslations(newLang);
    refreshProductsUI();
    refreshHistoryUI();
  });

  // small safety: ensure lastUpdated on old local items (upgrade)
  function upgradeLocalTimestamps(){
    let changed = false;
    products.forEach(p => { if(!p.lastUpdated){ p.lastUpdated = p._createdAt || now(); changed = true; }});
    sales.forEach(s => { if(!s.lastUpdated){ s.lastUpdated = s._createdAt || now(); changed = true; }});
    if(changed){ saveLS(LS_PRODUCTS(currentUID), products); saveLS(LS_SALES(currentUID), sales); markDirty(true); }
  }

  // ensure UI refresh once more shortly after load (fix timing)
  setTimeout(()=>{ refreshProductsUI(); refreshCartUI(); refreshHistoryUI(); }, 600);

})();
</script>
</body>
</html>
